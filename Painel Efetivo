const readline = require('readline');
const fs = require('fs');
const path = require('path');
const { spawn } = require('child_process');
let botProcess = null;

const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout
});

function lerStatus() {
  try {
    const data = fs.readFileSync(path.join(process.cwd(), 'config.json'), 'utf8');
    const config = JSON.parse(data);
    return config.status ? config.status.toUpperCase() : 'INDISPONÃVEL';
  } catch {
    return 'INDISPONÃVEL';
  }
}

function showMenu() {
  console.clear();
  const status = lerStatus();

  console.log(`
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘      Discord Multi-Bot Panel v1.2.0   â•‘
â•‘          Status do bot: ${status}             
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/ __| '_ \\ / _ \\| | | | |/ / _ \\ / _\` |/ _ \\ \\ / /
\\__ \\ | | | (_) | |_| |   < (_) | (_| |  __/\\ V /
|___/_| |_|\\___/ \\__,_|_|\\_\\___(_)__,_|\\___| \\_/

â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ discord.gg/seuservidor - Setup Menu â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚ â•­â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•® â”‚
â”‚ â”‚   No   â”‚ Setup Option                                     â”‚ â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ [ 1 ]  â”‚ Criar todos os arquivos do bot                   â”‚ â”‚
â”‚ â”‚ [ 2 ]  â”‚ Apenas criar config.json                         â”‚ â”‚
â”‚ â”‚ [ 3 ]  â”‚ Sair do painel                                   â”‚ â”‚
â”‚ â”‚ [ 4 ]  â”‚ Alterar token do bot                             â”‚ â”‚
â”‚ â”‚ [ 5 ]  â”‚ Ligar o bot (start)                              â”‚ â”‚
â”‚ â”‚ [ 6 ]  â”‚ Desligar o bot (stop)                            â”‚ â”‚
â”‚ â”‚ [ 7 ]  â”‚ Enviar mensagem para canal especÃ­fico            â”‚ â”‚
â”‚ â•°â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯ â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
`);

  rl.question('[SetupBot] â¤ Digite o nÃºmero da opÃ§Ã£o desejada: ', (answer) => {
    switch (answer.trim()) {
      case '1': criarArquivos(true); break;
      case '2': criarArquivos(false); break;
      case '3':
        console.log('âŒ Saindo...');
        rl.close();
        break;
      case '4': alterarToken(); break;
      case '5': ligarBot(); break;
      case '6': desligarBot(); break;
      case '7': enviarMensagem(); break;
      default:
        console.log('âš ï¸ OpÃ§Ã£o invÃ¡lida. Tente novamente.');
        setTimeout(showMenu, 1500);
    }
  });
}

function criarArquivos(tudo) {
  const estrutura = {
    'config.json': `{
  "status": "online",
  "token": "SEU_TOKEN_DO_BOT",
  "prefix": "!"
}`
  };

  if (tudo) {
    estrutura['index.js'] = `const { Client, GatewayIntentBits } = require('discord.js');
const config = require('./config.json');
const client = new Client({ intents: [GatewayIntentBits.Guilds, GatewayIntentBits.GuildMessages, GatewayIntentBits.MessageContent] });

client.once('ready', () => console.log(\`ğŸ¤– Bot online como \${client.user.tag}\`));
client.on('messageCreate', msg => {
  if (msg.content === config.prefix + "ping") msg.reply("ğŸ“ Pong!");
});
client.login(config.token);`;

    estrutura['commands/ping.js'] = `module.exports = {
  name: 'ping',
  description: 'Responde com Pong!',
  execute(message) {
    message.reply('ğŸ“ Pong!');
  },
};`;
  }

  for (const [caminho, conteudo] of Object.entries(estrutura)) {
    const completo = path.join(process.cwd(), caminho);
    const dir = path.dirname(completo);
    if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true });
    fs.writeFileSync(completo, conteudo.trim());
    console.log(`âœ… Arquivo criado: ${caminho}`);
  }

  if (tudo) {
    const pkgPath = path.join(process.cwd(), 'package.json');
    if (!fs.existsSync(pkgPath)) {
      const pkg = {
        name: 'discord-multi-bot',
        version: '1.0.0',
        main: 'index.js',
        scripts: { start: 'node index.js' },
        dependencies: { "discord.js": "^14.0.0" }
      };
      fs.writeFileSync(pkgPath, JSON.stringify(pkg, null, 2));
      console.log('ğŸ“¦ package.json criado!');
    }
  }

  console.log('\nğŸ‰ Setup finalizado! Execute:');
  console.log('   1ï¸âƒ£ npm install');
  console.log('   2ï¸âƒ£ node painel.js e escolha [5] para iniciar o bot');
  setTimeout(showMenu, 3000);
}

function alterarToken() {
  const configPath = path.join(process.cwd(), 'config.json');
  if (!fs.existsSync(configPath)) {
    console.log('âš ï¸ config.json nÃ£o encontrado!');
    return setTimeout(showMenu, 1500);
  }
  rl.question('[TokenBot] â¤ Digite o novo token: ', (novoToken) => {
    try {
      const config = JSON.parse(fs.readFileSync(configPath, 'utf8'));
      config.token = novoToken;
      fs.writeFileSync(configPath, JSON.stringify(config, null, 2));
      console.log('âœ… Token atualizado!');
    } catch (err) {
      console.log('âŒ Erro ao alterar token:', err.message);
    }
    setTimeout(showMenu, 1500);
  });
}

function ligarBot() {
  if (botProcess) {
    console.log('âš ï¸ Bot jÃ¡ estÃ¡ em execuÃ§Ã£o.');
    return setTimeout(showMenu, 1500);
  }
  botProcess = spawn('node', ['index.js'], { stdio: 'inherit' });
  console.log('âœ… Bot iniciado.');
  setTimeout(showMenu, 1500);
}

function desligarBot() {
  if (botProcess) {
    botProcess.kill();
    botProcess = null;
    console.log('ğŸ›‘ Bot desligado.');
  } else {
    console.log('âš ï¸ Bot nÃ£o estÃ¡ em execuÃ§Ã£o.');
  }
  setTimeout(showMenu, 1500);
}

function enviarMensagem() {
  rl.question('[Canal] â¤ Cole o link do canal (ex: https://discord.com/channels/123/456): ', (link) => {
    rl.question('[Mensagem] â¤ Digite a mensagem: ', (texto) => {
      const partes = link.split('/');
      const channelId = partes[partes.length - 1];
      const config = JSON.parse(fs.readFileSync('./config.json', 'utf8'));
      const { Client, GatewayIntentBits } = require('discord.js');
      const client = new Client({ intents: [GatewayIntentBits.Guilds, GatewayIntentBits.GuildMessages] });

      client.once('ready', async () => {
        try {
          const canal = await client.channels.fetch(channelId);
          if (!canal) throw new Error('Canal nÃ£o encontrado.');
          await canal.send(texto);
          console.log('âœ… Mensagem enviada com sucesso!');
        } catch (e) {
          console.log('âŒ Erro ao enviar mensagem:', e.message);
        }
        client.destroy();
        setTimeout(showMenu, 1500);
      });

      client.login(config.token);
    });
  });
}

// Inicializa mostrando o menu
showMenu();
