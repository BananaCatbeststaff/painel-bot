const readline = require('readline');
const fs = require('fs');
const path = require('path');
const { spawn } = require('child_process');

let botProcess = null;

const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout
});

// Cores ANSI para terminal
const colors = {
  reset: '\x1b[0m',
  bright: '\x1b[1m',

  fgRed: '\x1b[31m',
  fgGreen: '\x1b[32m',
  fgYellow: '\x1b[33m',
  fgBlue: '\x1b[34m',
  fgMagenta: '\x1b[35m',
  fgCyan: '\x1b[36m',
  fgWhite: '\x1b[37m',
};

// Mensagem de boas-vindas e delay para mostrar o menu
function welcomeMessage() {
  console.clear();
  console.log(colors.fgCyan + colors.bright);
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  console.log('   ğŸ”¥ Bem-vindo ao Discord Multi-Bot Panel v1.2.0 ğŸ”¥      ');
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' + colors.reset);
  console.log('Use este painel para criar, configurar e controlar seu bot.\n');
  setTimeout(showMenu, 2000);
}

// Menu principal com opÃ§Ãµes
function showMenu() {
  console.clear();
  console.log(colors.fgMagenta + colors.bright + `
/ __| '_ \\ / _ \\| | | | |/ / _ \\ / _\` |/ _ \\ \\ / /
\\__ \\ | | | (_) | |_| |   < (_) | (_| |  __/\\ V /
|___/_| |_|\\___/ \\__,_|_|\\_\\___(_)__,_|\\___| \\_/

` + colors.reset);

  console.log(
    colors.fgYellow + colors.bright +
    '- Version: 1.2.0 | Discord Multi-Bot Panel\n' +
    '- Credit: YourName.dev\n' +
    '- Status: Multi-funcional\n\n' +
    colors.reset
  );

  console.log(colors.fgCyan +
    'â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ' + colors.fgGreen + 'discord.gg/seuservidor' + colors.fgCyan + ' - Setup Menu â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®' + colors.reset
  );
  console.log(colors.fgCyan +
    'â”‚ â•­â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•® â”‚' + colors.reset
  );
  console.log(colors.fgBlue +
    'â”‚ â”‚   No   â”‚ Setup Option                                     â”‚ â”‚' + colors.reset
  );
  console.log(colors.fgBlue +
    'â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚' + colors.reset
  );
  [
    '[ 1 ]  Criar todos os arquivos do bot',
    '[ 2 ]  Apenas criar config.json',
    '[ 3 ]  Sair do painel',
    '[ 4 ]  Alterar token do bot',
    '[ 5 ]  Ligar o bot (start)',
    '[ 6 ]  Desligar o bot (stop)',
    '[ 7 ]  Enviar mensagem para canal especÃ­fico',
    '[ 8 ]  Enviar mensagem com embed personalizado',
  ].forEach((text, i) => {
    console.log(colors.fgWhite + `â”‚ â”‚ ${text.padEnd(48)} â”‚ â”‚` + colors.reset);
  });
  console.log(colors.fgCyan +
    'â”‚ â•°â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯ â”‚' + colors.reset
  );
  console.log(colors.fgCyan +
    'â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯\n' + colors.reset
  );

  rl.question(colors.fgGreen + '[SetupBot] â¤ Digite o nÃºmero da opÃ§Ã£o desejada: ' + colors.reset, handleInput);
}

// Handler central das opÃ§Ãµes do menu
function handleInput(answer) {
  switch (answer.trim()) {
    case '1': criarArquivos(true); break;
    case '2': criarArquivos(false); break;
    case '3':
      console.log(colors.fgRed + 'âŒ Saindo...' + colors.reset);
      rl.close();
      break;
    case '4': alterarToken(); break;
    case '5': ligarBot(); break;
    case '6': desligarBot(); break;
    case '7': enviarMensagem(); break;
    case '8': enviarMensagemEmbed(); break;
    default:
      console.log(colors.fgRed + 'âš ï¸ OpÃ§Ã£o invÃ¡lida. Tente novamente.' + colors.reset);
      setTimeout(showMenu, 1500);
  }
}

// Cria arquivos bÃ¡sicos do bot
function criarArquivos(tudo) {
  const estrutura = {
    'config.json': `{
  "token": "SEU_TOKEN_DO_BOT",
  "prefix": "!"
}`
  };

  if (tudo) {
    estrutura['index.js'] = `const { Client, GatewayIntentBits } = require('discord.js');
const config = require('./config.json');
const client = new Client({ intents: [GatewayIntentBits.Guilds, GatewayIntentBits.GuildMessages, GatewayIntentBits.MessageContent] });

client.once('ready', () => console.log(\`ğŸ¤– Bot online como \${client.user.tag}\`));
client.on('messageCreate', msg => {
  if (msg.content === config.prefix + "ping") msg.reply("ğŸ“ Pong!");
});
client.login(config.token);`;

    estrutura['commands/ping.js'] = `module.exports = {
  name: 'ping',
  description: 'Responde com Pong!',
  execute(message) {
    message.reply('ğŸ“ Pong!');
  },
};`;
  }

  for (const [caminho, conteudo] of Object.entries(estrutura)) {
    const completo = path.join(process.cwd(), caminho);
    const dir = path.dirname(completo);
    if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true });
    fs.writeFileSync(completo, conteudo.trim());
    console.log(colors.fgGreen + `âœ… Arquivo criado: ${caminho}` + colors.reset);
  }

  if (tudo) {
    const pkgPath = path.join(process.cwd(), 'package.json');
    if (!fs.existsSync(pkgPath)) {
      const pkg = {
        name: 'discord-multi-bot',
        version: '1.0.0',
        main: 'index.js',
        scripts: { start: 'node index.js' },
        dependencies: { "discord.js": "^14.0.0" }
      };
      fs.writeFileSync(pkgPath, JSON.stringify(pkg, null, 2));
      console.log(colors.fgGreen + 'ğŸ“¦ package.json criado!' + colors.reset);
    }
  }

  console.log(colors.fgYellow + '\nğŸ‰ Setup finalizado! Execute:' + colors.reset);
  console.log('   1ï¸âƒ£ npm install');
  console.log('   2ï¸âƒ£ node painel.js e escolha [5] para iniciar o bot');
  setTimeout(showMenu, 2500);
}

// FunÃ§Ã£o para alterar o token do bot no config.json
function alterarToken() {
  const configPath = path.join(process.cwd(), 'config.json');
  if (!fs.existsSync(configPath)) {
    console.log(colors.fgRed + 'âš ï¸ config.json nÃ£o encontrado!' + colors.reset);
    setTimeout(showMenu, 1500);
    return;
  }
  rl.question(colors.fgCyan + '[TokenBot] â¤ Digite o novo token: ' + colors.reset, (novoToken) => {
    try {
      const config = JSON.parse(fs.readFileSync(configPath, 'utf8'));
      config.token = novoToken;
      fs.writeFileSync(configPath, JSON.stringify(config, null, 2));
      console.log(colors.fgGreen + 'âœ… Token atualizado!' + colors.reset);
    } catch (err) {
      console.log(colors.fgRed + 'âŒ Erro ao alterar token:', err.message + colors.reset);
    }
    setTimeout(showMenu, 1500);
  });
}

// FunÃ§Ã£o para iniciar o bot com spawn e capturar saÃ­da
function ligarBot() {
  if (botProcess) {
    console.log(colors.fgYellow + 'âš ï¸ Bot jÃ¡ estÃ¡ rodando!' + colors.reset);
    setTimeout(showMenu, 1500);
    return;
  }
  const indexPath = path.join(process.cwd(), 'index.js');
  if (!fs.existsSync(indexPath)) {
    console.log(colors.fgRed + 'âŒ index.js nÃ£o encontrado. Crie os arquivos primeiro.' + colors.reset);
    setTimeout(showMenu, 1500);
    return;
  }

  console.log(colors.fgGreen + 'â–¶ï¸ Ligando o bot...' + colors.reset);
  botProcess = spawn('node', ['index.js'], { stdio: 'inherit' });

  botProcess.on('close', (code) => {
    console.log(colors.fgYellow + `âš ï¸ Bot finalizado com cÃ³digo ${code}` + colors.reset);
    botProcess = null;
    setTimeout(showMenu, 1500);
  });

  botProcess.on('error', (err) => {
    console.log(colors.fgRed + 'âŒ Erro ao iniciar o bot:', err.message + colors.reset);
    botProcess = null;
    setTimeout(showMenu, 1500);
  });
}

// FunÃ§Ã£o para desligar o processo do bot
function desligarBot() {
  if (!botProcess) {
    console.log(colors.fgYellow + 'âš ï¸ Bot nÃ£o estÃ¡ rodando!' + colors.reset);
    setTimeout(showMenu, 1500);
    return;
  }
  botProcess.kill();
  console.log(colors.fgGreen + 'âœ… Bot desligado!' + colors.reset);
  botProcess = null;
  setTimeout(showMenu, 1500);
}

// FunÃ§Ã£o para enviar mensagem simples para um canal especÃ­fico
function enviarMensagem() {
  rl.question(colors.fgCyan + '[Mensagem] â¤ ID do canal: ' + colors.reset, (channelId) => {
    rl.question(colors.fgCyan + '[Mensagem] â¤ ConteÃºdo da mensagem: ' + colors.reset, (msg) => {
      // Precisamos garantir o botProcess estÃ¡ rodando e expor um modo para enviar mensagem
      if (!botProcess) {
        console.log(colors.fgRed + 'âŒ Bot nÃ£o estÃ¡ rodando. Ligue o bot antes.' + colors.reset);
        setTimeout(showMenu, 1500);
        return;
      }
      // Uma forma simples: criar um arquivo JSON que o bot lÃª periodicamente para enviar a mensagem,
      // ou implementar um IPC, mas para simplicidade aqui, sÃ³ informar que comando nÃ£o implementado.
      console.log(colors.fgYellow + 'âš ï¸ FunÃ§Ã£o de envio de mensagem nÃ£o implementada nesta versÃ£o.' + colors.reset);
      setTimeout(showMenu, 1500);
    });
  });
}

// FunÃ§Ã£o para enviar mensagem embed personalizada - similar a enviarMensagem
function enviarMensagemEmbed() {
  console.log(colors.fgYellow + 'âš ï¸ FunÃ§Ã£o de envio de embed nÃ£o implementada nesta versÃ£o.' + colors.reset);
  setTimeout(showMenu, 1500);
}

// Inicializa a aplicaÃ§Ã£o
welcomeMessage();
